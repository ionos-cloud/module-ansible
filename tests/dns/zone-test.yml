- hosts: localhost
  connection: local
  gather_facts: false

  vars_files:
    - ./vars.yml

  tasks:

  - name: Create Zone
    dns_zone:
      name: "{{zone_name}}"
      description: "{{zone_description}}"
      enabled: "{{zone_enabled}}"
    register: zone_response

  # - name: Print output to file
  #   ansible.builtin.copy:
  #     content: "{{zone_response}}"
  #     dest: ../../docs/returned_object_examples/dns_zone.json

  - name: List Zones
    dns_zone_info:
    register: zones_response

  # - name: Print output to file
  #   ansible.builtin.copy:
  #     content: "{{zones_response}}"
  #     dest: ../../docs/returned_object_examples/dns_zone_info.json

  - name: Show Zones
    debug:
      var: zones_response.zones

  - name: Update Zone
    dns_zone:
      zone: "{{ zone_response.zone.properties.zone_name }}"
      description: "{{zone_description_updated}}"
      enabled: "{{zone_enabled_updated}}"
      allow_replace: False
      state: update
    register: updated_zone_response

  - name: Update Zone no change
    dns_zone:
      zone: "{{ zone_response.zone.properties.zone_name }}"
      description: "{{zone_description_updated}}"
      enabled: "{{zone_enabled_updated}}"
      allow_replace: False
      state: update
    register: updated_zone_response

  - name: Asserting that changed == false when no update is made
    assert:
      that:
        - updated_zone_response.changed == false
      msg: "Changed should be false"

  - name: Create Zone key
    dns_key:
      zone: "{{ zone_response.zone.properties.zone_name }}"
      validity: 100
      algorithm: RSASHA256
      ksk_bits: 4096
      zsk_bits: 2048
      nsec_mode: NSEC
      nsec3_iterations: 2
      nsec3_salt_bits: 64
      state: present
    register: key_response

  - name: Print output to file
    ansible.builtin.copy:
      content: "{{key_response}}"
      dest: ../../docs/returned_object_examples/dns_key.json

  - name: Get Zone key
    dns_key_info:
      zone: "{{ zone_response.zone.properties.zone_name }}"
    register: zone_keys_response

  - name: Show Zone keys
    debug:
      var: zone_keys_response

  # - name: Print output to file
  #   ansible.builtin.copy:
  #     content: "{{zone_keys_response}}"
  #     dest: ../../docs/returned_object_examples/dns_key_info.json

  - name: Delete Zone key
    dns_key:
      zone: "{{ zone_response.zone.properties.zone_name }}"
      state: absent
    register: key_response

  - name: Delete Zone
    dns_zone:
      zone: "{{ zone_response.zone.properties.zone_name }}"
      wait: true
      state: absent
